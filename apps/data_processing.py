import pandas as pd
import statsmodels.api as sm

# Load Data
df = pd.read_csv("data/openFEMA_claims20190630.csv", encoding='utf-8', parse_dates=['dateofloss'], nrows=100000)
cat_columns = ['agriculturestructureindicator', 'basementenclosurecrawlspacetype', 'condominiumindicator', 'elevatedbuildingindicator', 'elevationcertificateindicator', 'floodzone', 'houseworship', 'locationofcontents', 'numberoffloorsintheinsuredbuilding', 'nonprofitindicator', 'obstructiontype', 'occupancytype', 'postfirmconstructionindicator', 'ratemethod', 'smallbusinessindicatorbuilding', 'state', 'primaryresidence']
df['yearofloss'] = df['dateofloss'].dt.year
df['monthofloss'] = df['dateofloss'].dt.month
df[cat_columns] = df[cat_columns].astype('str')
df.drop(columns=['lowestfloorelevation', 'asofdate'], inplace=True)
columns = df.columns
num_columns = [column for column in df.columns if column not in cat_columns]

df_state = df.groupby('state')['amountpaidonbuildingclaim', 'amountpaidoncontentsclaim'].mean()
df_year_claims = df.groupby(['yearofloss'])['amountpaidoncontentsclaim', 'amountpaidonbuildingclaim'].mean().reset_index()

disaster_df = pd.read_csv("data/DisasterDeclarationsSummaries.csv", parse_dates=['declarationDate'])
columns = ['state', 'declarationDate', 'disasterType', 'incidentType', 'title', 'declaredCountyArea']
disaster_nums = disaster_df[columns]
disaster_nums['yearofloss'] = disaster_nums['declarationDate'].dt.year
disaster_nums['month'] = disaster_nums['declarationDate'].dt.month
disaster_nums.drop(columns=['declarationDate', 'disasterType', 'title'], inplace=True)
disaster_nums = disaster_nums[disaster_nums['yearofloss'].between(1984,2019)]

df_count_year = disaster_nums[disaster_nums['incidentType'] == 'Flood'].groupby(['state', 'yearofloss'])['incidentType'].count().reset_index()
dff_year_claims = df_count_year.groupby('state')['incidentType'].sum()

df_lr = pd.concat([dff_year_claims, df_state[['amountpaidonbuildingclaim', 'amountpaidoncontentsclaim']]], axis=1)
df_lr.dropna(inplace=True)

X = sm.add_constant(df_lr['incidentType'])
y = df_lr['amountpaidonbuildingclaim']
y1 = df_lr['amountpaidoncontentsclaim']

model = sm.OLS(y, X).fit()
model1 = sm.OLS(y1, X).fit()

'''
vulnerability score preprocessing
'''
df_merged = pd.read_csv('data/vulnerability_score_map.csv')