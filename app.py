import dash
import dash_core_components as dcc
import dash_html_components as html
import dash_bootstrap_components as dbc
from dash.dependencies import Input, Output

import pandas as pd
import plotly.graph_objs as go

external_stylesheets = ['https://codepen.io/chriddyp/pen/bWLwgP.css']

# Load Data
df = pd.read_csv("data/openFEMA_claims20190430.csv", encoding='utf-8', parse_dates=['dateofloss'], nrows=100000)
cat_columns = ['agriculturestructureindicator', 'basementenclosurecrawlspacetype', 'condominiumindicator', 'countycode', 'elevatedbuildingindicator', 'elevationcertificateindicator', 'censustract', 'floodzone', 'houseworship', 'locationofcontents', 'numberoffloorsintheinsuredbuilding', 'nonprofitindicator', 'obstructiontype', 'occupancytype', 'postfirmconstructionindicator', 'ratemethod', 'smallbusinessindicatorbuilding', 'state', 'reportedzipcode', 'primaryresidence']
df[cat_columns] = df[cat_columns].astype('category')
df['year'] = df['dateofloss'].dt.year
df['month'] = df['dateofloss'].dt.month
df.drop(columns=['yearofloss', 'lowestfloorelevation', 'asofdate'], inplace=True)

df_year_claims = df.groupby(['year'])['amountpaidoncontentsclaim', 'amountpaidonbuildingclaim'].mean().reset_index()

disaster_df = pd.read_csv("data/DisasterDeclarationsSummaries.csv", parse_dates=['declarationDate'])
columns = ['state', 'declarationDate', 'disasterType', 'incidentType', 'title', 'declaredCountyArea']
disaster_nums = disaster_df[columns]
disaster_nums['year'] = disaster_nums['declarationDate'].dt.year
disaster_nums['month'] = disaster_nums['declarationDate'].dt.month
disaster_nums.drop(columns=['declarationDate', 'disasterType', 'title'], inplace=True)

disaster_count_year = disaster_nums.groupby(['state', 'year'])['incidentType'].count().reset_index()
disaster_count_year.head()

navbar = dbc.NavbarSimple(
    children=[
        dbc.NavItem(dbc.NavLink("Github", href="https://github.com/khyu777/climate_vulnerability"))
    ],
    brand="Climate Vulnerability",
    brand_href="#",
    sticky="top",
)

claim_map = html.Div(
    [
        dbc.Row(
            [
                dbc.Col(
                    html.Div([
                        html.P("Filter  Map", className='control_label'),
                        dcc.Dropdown(
                            id='data-type',
                            options=[
                                {'label': 'Building Claim', 'value': 'Amount Paid on Building Claim'},
                                {'label': 'Contents Claim', 'value': 'Amount Paid on Contents Claim'}
                                ],
                            style= {
                                'font-size': '14px',
                                'width':'150px'
                            },
                            value='Amount Paid on Building Claim'
                        ),
                    ]),
                    width={'size':1},
                ),
                dbc.Col(
                    dbc.Card(
                        [
                            dcc.Graph(id='usa-map'),
                            dcc.RangeSlider(
                                id='year-slider',
                                min = df['year'].min(),
                                max = df['year'].max(),
                                value = [df['year'].min(), df['year'].max()],
                                marks = {
                                    str(year): {
                                        'label': str(year),
                                        'style': {'transform': 'rotate(-65deg)' 'scale(0.8,0.8)' 'translate(-20px, -10px)'}
                                        } for year in df['year'].unique()
                                    },
                            )
                        ],
                    ),
                    width = {'size':4},
                ),
                dbc.Col(
                    dbc.Card(
                        dcc.Graph(
                            id='trend',
                            figure={
                                'data': [
                                    go.Scatter(
                                        y=df_year_claims['amountpaidoncontentsclaim'],
                                        x=df_year_claims['year'],
                                        mode='lines+markers',
                                        name='Amount Paid on Contents Claim'
                                        ),
                                    go.Scatter(
                                        y=df_year_claims['amountpaidonbuildingclaim'],
                                        x=df_year_claims['year'],
                                        mode='lines+markers',
                                        name='Amount Paid on Building Claim'
                                        )
                                    ],
                                'layout': go.Layout(
                                    title='Claim Amount Trend over Time',
                                    showlegend=True,
                                    legend=dict(x=0.1, y=0.95),
                                    paper_bgcolor='rgba(0,0,0,0)',
                                    plot_bgcolor='rgba(0,0,0,0)',
                                    height=465,
                                )
                            }
                        )
                    ),
                    width={'size': 5}
                ),
            ],
            justify="center",
            style={
                'padding-bottom': '50px'
            }
        ),
    ],
    className="mt-4",
)

disaster_map = html.Div(
    [
        dbc.Row(
            [
                dbc.Col(
                    dbc.Card(
                        [
                            dcc.Graph(id='disaster-map'),
                            dcc.RangeSlider(
                                id='ds-year-slider',
                                min = disaster_count_year['year'].min(),
                                max = disaster_count_year['year'].max(),
                                value = [disaster_count_year['year'].min(), disaster_count_year['year'].max()],
                                marks = {
                                    str(year): {
                                        'label': str(year),
                                        'style': {'transform': 'rotate(-65deg)' 'scale(0.8,0.8)' 'translate(-20px, -10px)'}
                                        } for year in disaster_count_year['year'].unique()
                                    },
                            )
                        ]
                    ),
                    width = {'size':5}
                ),
            ],
            justify = 'center'
        ),
    ]
)

app = dash.Dash(__name__, external_stylesheets=[dbc.themes.FLATLY])

server = app.server

app.layout = html.Div(
    [
        navbar,
        claim_map,
        disaster_map
    ]
)

@app.callback(
    Output('usa-map', 'figure'),
    [Input('data-type', 'value'),
    Input('year-slider', 'value')]
)
def update_map(data, year_value):
    df_year = df[df['year'].between(year_value[0], year_value[1])]
    dff_state = df_year.groupby('state')['amountpaidonbuildingclaim', 'amountpaidoncontentsclaim'].mean()
    dff_state.columns = ['Amount Paid on Building Claim', 'Amount Paid on Contents Claim']
    return {
            'data': [go.Choropleth(
                    locations = dff_state.index,
                    z = round(dff_state[data], 2),
                    locationmode = 'USA-states',
                    colorscale = 'Reds',
                    colorbar_title = "USD")
            ],
            'layout': go.Layout(
                title_text = data + ' by State',
                geo_scope='usa', # limite map scope to USA
                margin={
                    'l': 25,
                    'r': 0,
                    'b': 25,
                    't': 100,
                }
            )
        }

@app.callback(
    Output('disaster-map', 'figure'),
    [Input('ds-year-slider', 'value')]
)

def update_ds_map(year_value):
    df_ds_year = disaster_count_year[disaster_count_year['year'].between(year_value[0], year_value[1])]
    dff_year_claims = df_ds_year.groupby('state')['incidentType'].sum()
    return {
        'data': [
            go.Choropleth(
                locations = dff_year_claims.index,
                z = dff_year_claims,
                locationmode = 'USA-states',
                colorscale = 'Blues'
            )
        ],
        'layout': go.Layout(
            title_text = "Various Natural Disaster Count (" + str(year_value[0]) + " - " + str(year_value[1]) + ")",
            geo_scope = 'usa'
        )
    }

if __name__ == '__main__':
    app.run_server(debug=True)