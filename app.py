import dash
import dash_core_components as dcc
import dash_html_components as html

import pandas as pd
import plotly.graph_objs as go

external_stylesheets = ['https://codepen.io/chriddyp/pen/bWLwgP.css']

app = dash.Dash(__name__, external_stylesheets=external_stylesheets)

# Load Data
df = pd.read_csv("data/openFEMA_claims20190430.csv", encoding='utf-8', parse_dates=['dateofloss'])
cat_columns = ['agriculturestructureindicator', 'basementenclosurecrawlspacetype', 'condominiumindicator', 'countycode', 'elevatedbuildingindicator', 'elevationcertificateindicator', 'censustract', 'floodzone', 'houseworship', 'locationofcontents', 'numberoffloorsintheinsuredbuilding', 'nonprofitindicator', 'obstructiontype', 'occupancytype', 'postfirmconstructionindicator', 'ratemethod', 'smallbusinessindicatorbuilding', 'state', 'reportedzipcode', 'primaryresidence']
df[cat_columns] = df[cat_columns].astype('category')
df['year'] = df['dateofloss'].dt.year
df['month'] = df['dateofloss'].dt.month
df.drop(columns=['yearofloss', 'lowestfloorelevation', 'asofdate'], inplace=True)

df_state = df.groupby('state')['amountpaidonbuildingclaim', 'amountpaidoncontentsclaim'].mean().reset_index()

app.layout = html.Div([
    html.H1(
        children='Hello Dash',
        style={
            'textAlign': 'center'
        }
    ),
    dcc.Dropdown(
        id='data-type',
        options=[{'label': i, 'value': i} for i in df_state.columns],
        value='amountpaidonbuildingclaim'
    ),

    dcc.Graph(
        id='example-graph',
        figure={
            'data': [go.Choropleth(
                    locations = df_state['state'],
                    z = round(df_state['amountpaidoncontentsclaim'], 2),
                    locationmode = 'USA-states',
                    colorscale = 'Reds',
                    colorbar_title = "USD")
            ],
            'layout': go.Layout(
                title_text = 'Average Amount Paid on Content Claims by State',
                geo_scope='usa', # limite map scope to USA
            )
        }
    )
])



if __name__ == '__main__':
    app.run_server(debug=True)